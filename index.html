<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento Sala de Tecnologia - EE Joelina</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 1150px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1a5276; margin-bottom: 5px; }
        .sub { text-align: center; color: #666; margin-bottom: 25px; font-size: 0.9em; }
        
        .seletor-data { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 25px; padding: 15px; background: #e8f4fd; border-radius: 8px; border: 1px solid #b3d7f2; }
        input[type="date"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th { background-color: #2980b9; color: white; padding: 12px; font-size: 14px; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        
        .editando { background-color: #fff3cd !important; transition: 0.3s; border: 2px solid #f1c40f !important; }
        .ocupado { background-color: #f8d7da !important; color: #721c24; cursor: not-allowed; }

        input, textarea { width: 92%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
        input:focus, textarea:focus { border-color: #2980b9; outline: none; background-color: #fff; }
        input:disabled, textarea:disabled { background: transparent; border: none; color: #721c24; font-weight: bold; text-align: center; }

        .btn-salvar { background: #27ae60; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-size: 18px; margin-top: 20px; font-weight: bold; }
        .btn-salvar:hover { background: #219150; }
        #loading { font-weight: bold; color: #2980b9; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>AGENDAMENTO SALA DE TECNOLOGIA</h2>
    <p class="sub">Gest√£o PCPI - EE Prof¬™ Joelina de Almeida Xavier</p>

    <div class="seletor-data">
        <label>Selecione a Data: </label>
        <input type="date" id="data-aula" onchange="consultarAgenda()" 
               min="2026-02-09" 
               max="2026-02-28">
        <span id="loading" style="display:none;">‚è≥ Sincronizando...</span>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Tempo</th>
                <th>Hor√°rio (4¬∫/5¬∫)</th>
                <th>Hor√°rio (6¬∫/9¬∫)</th>
                <th>Turma</th>
                <th>Professor</th>
                <th>Atividade</th>
            </tr>
        </thead>
        <tbody id="grade-horarios"></tbody>
    </table>

    <button class="btn-salvar" id="btnSalvar" onclick="salvarTudo()">üíæ Salvar Agendamentos Completos</button>
</div>

<script>
    const CONST_URL_SCRIPT = "https://script.google.com/macros/s/AKfycbzYl_3pGWnjpzwuh2PlgEoBCLQTfqZ1reT4wp_NkW_xX88vtGdxdQF0FDQ68KTVA7M/exec";

    const horarios = [
        { id: "1T", t: "1¬∫ Tempo", h1: "07:25 - 08:15", h2: "07:25 - 08:15" },
        { id: "2T", t: "2¬∫ Tempo", h1: "08:15 - 09:05", h2: "08:15 - 09:05" },
        { id: "3T", t: "3¬∫ Tempo", h1: "09:20 - 10:10", h2: "09:05 - 10:55" },
        { id: "4T", t: "4¬∫ Tempo", h1: "10:10 - 11:00", h2: "10:10 - 11:00" },
        { id: "5T_F1", t: "5¬∫ Tempo", h1: "12:00 - 12:50", h2: "---" }, 
        { id: "5T_F2", t: "5¬∫ Tempo", h1: "---",           h2: "11:00 - 11:50" },
        { id: "6T", t: "6¬∫ Tempo", h1: "12:50 - 13:40", h2: "12:50 - 13:40" },
        { id: "7T", t: "7¬∫ Tempo", h1: "13:55 - 14:45", h2: "13:40 - 14:30" },
        { id: "8T", t: "8¬∫ Tempo", h1: "14:45 - 15:35", h2: "14:45 - 15:35" }
    ];

    function desenharTabela() {
        const corpo = document.getElementById('grade-horarios');
        corpo.innerHTML = "";
        horarios.forEach((item) => {
            corpo.innerHTML += `
                <tr id="linha-${item.id}">
                    <td><strong>${item.t}</strong></td>
                    <td>${item.h1}</td>
                    <td>${item.h2}</td>
                    <td><input type="text" id="turma-${item.id}" oninput="validarLinha('${item.id}')" placeholder="Ex: 5¬∫A"></td>
                    <td><input type="text" id="prof-${item.id}" oninput="validarLinha('${item.id}')" placeholder="Seu Nome"></td>
                    <td><textarea id="ativ-${item.id}" rows="1" oninput="validarLinha('${item.id}')" placeholder="Conte√∫do"></textarea></td>
                </tr>`;
        });
    }

    function validarLinha(id) {
        const linha = document.getElementById(`linha-${id}`);
        const turma = document.getElementById(`turma-${id}`).value.trim();
        const prof = document.getElementById(`prof-${id}`).value.trim();
        const ativ = document.getElementById(`ativ-${id}`).value.trim();
        
        if (turma !== "" && prof !== "" && ativ !== "" && !linha.classList.contains('ocupado')) {
            linha.classList.add('editando');
        } else {
            linha.classList.remove('editando');
        }
    }

    async function consultarAgenda() {
        const data = document.getElementById('data-aula').value;
        if (!data) return;
        document.getElementById('loading').style.display = "inline";
        desenharTabela();

        try {
            const response = await fetch(`${CONST_URL_SCRIPT}?data=${data}`);
            const agendados = await response.json();
            agendados.forEach(reserva => {
                const linha = document.getElementById(`linha-${reserva.id_unico}`);
                if (linha) {
                    linha.classList.add('ocupado');
                    document.getElementById(`turma-${reserva.id_unico}`).value = reserva.turma;
                    document.getElementById(`prof-${reserva.id_unico}`).value = reserva.professor;
                    document.getElementById(`ativ-${reserva.id_unico}`).value = reserva.atividade;
                    document.getElementById(`turma-${reserva.id_unico}`).disabled = true;
                    document.getElementById(`prof-${reserva.id_unico}`).disabled = true;
                    document.getElementById(`ativ-${reserva.id_unico}`).disabled = true;
                }
            });
        } catch (err) { console.error(err); }
        document.getElementById('loading').style.display = "none";
    }

    async function salvarTudo() {
        const data = document.getElementById('data-aula').value;
        if (!data) { alert("Escolha uma data!"); return; }

        const agendamentos = [];
        horarios.forEach(h => {
            const linha = document.getElementById(`linha-${h.id}`);
            if (linha.classList.contains('editando')) {
                agendamentos.push({
                    data, id_unico: h.id, tempo: h.t,
                    turma: document.getElementById(`turma-${h.id}`).value,
                    professor: document.getElementById(`prof-${h.id}`).value,
                    atividade: document.getElementById(`ativ-${h.id}`).value
                });
            }
        });

        if (agendamentos.length === 0) {
            alert("‚ö†Ô∏è Preencha Turma, Professor e Atividade para salvar o hor√°rio.");
            return;
        }

        const btn = document.getElementById('btnSalvar');
        btn.disabled = true;
        btn.innerText = "‚è≥ Gravando...";

        try {
            for (const item of agendamentos) {
                await fetch(CONST_URL_SCRIPT, { method: 'POST', body: JSON.stringify(item) });
            }
            alert("‚úÖ Agendamentos salvos!");
            consultarAgenda();
        } catch (err) { alert("Erro ao salvar."); }
        btn.disabled = false;
        btn.innerText = "üíæ Salvar Agendamentos Completos";
    }

    desenharTabela();
</script>
</body>
</html>